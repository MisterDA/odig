<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>BatLogger (batteries.BatLogger)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">batteries</a> &#x00BB; BatLogger</nav><h1>Module <code>BatLogger</code></h1><h2 id="logging-library"><a href="#logging-library" class="anchor"></a>Logging Library</h2><p>This module defines functions which implement a flexible error logging system for applications.</p><dl><dt>author</dt><dd>Warren Harris, Metaweb Technologies</dd></dl><nav class="toc"><ul><li><a href="#log-modules">log modules</a></li><li><a href="#log-events">log events</a></li><li><a href="#log-formatters">log formatters</a></li><li><a href="#logger-initialization">logger initialization</a></li><li><a href="#log-utilities">log utilities</a></li></ul></nav></header><section><header><h6 id="log-modules"><a href="#log-modules" class="anchor"></a>log modules</h6></header><dl><dt class="spec type" id="type-log"><a href="#type-log" class="anchor"></a><code><span class="keyword">type </span>log</code></dt><dt class="spec type" id="type-level"><a href="#type-level" class="anchor"></a><code><span class="keyword">type </span>level</code><code><span class="keyword"> = </span></code><table class="variant"><tr id="type-level.NONE" class="anchored"><td class="def constructor"><a href="#type-level.NONE" class="anchor"></a><code><span class="keyword">| </span></code><code><span class="constructor">NONE</span></code></td></tr><tr id="type-level.FATAL" class="anchored"><td class="def constructor"><a href="#type-level.FATAL" class="anchor"></a><code><span class="keyword">| </span></code><code><span class="constructor">FATAL</span></code></td></tr><tr id="type-level.ERROR" class="anchored"><td class="def constructor"><a href="#type-level.ERROR" class="anchor"></a><code><span class="keyword">| </span></code><code><span class="constructor">ERROR</span></code></td></tr><tr id="type-level.WARN" class="anchored"><td class="def constructor"><a href="#type-level.WARN" class="anchor"></a><code><span class="keyword">| </span></code><code><span class="constructor">WARN</span></code></td></tr><tr id="type-level.NOTICE" class="anchored"><td class="def constructor"><a href="#type-level.NOTICE" class="anchor"></a><code><span class="keyword">| </span></code><code><span class="constructor">NOTICE</span></code></td></tr><tr id="type-level.INFO" class="anchored"><td class="def constructor"><a href="#type-level.INFO" class="anchor"></a><code><span class="keyword">| </span></code><code><span class="constructor">INFO</span></code></td></tr><tr id="type-level.DEBUG" class="anchored"><td class="def constructor"><a href="#type-level.DEBUG" class="anchor"></a><code><span class="keyword">| </span></code><code><span class="constructor">DEBUG</span></code></td></tr></table></dt></dl><dl><dt class="spec value" id="val-make_log"><a href="#val-make_log" class="anchor"></a><code><span class="keyword">val </span>make_log : string <span>&#45;&gt;</span> <a href="index.html#type-log">log</a></code></dt><dd><p><code>make_log name</code> returns a new logger.</p></dd></dl><dl><dt class="spec value" id="val-log_name"><a href="#val-log_name" class="anchor"></a><code><span class="keyword">val </span>log_name : <a href="index.html#type-log">log</a> <span>&#45;&gt;</span> string</code></dt><dd><p><code>log_name logger</code> returns the name of the logger.</p></dd></dl><dl><dt class="spec value" id="val-log_enable"><a href="#val-log_enable" class="anchor"></a><code><span class="keyword">val </span>log_enable : <a href="index.html#type-log">log</a> <span>&#45;&gt;</span> <a href="index.html#type-level">level</a> <span>&#45;&gt;</span> unit</code></dt><dd><p><code>log_enable logger level</code> enables a log level for a logger.</p></dd></dl><dl><dt class="spec value" id="val-log_level"><a href="#val-log_level" class="anchor"></a><code><span class="keyword">val </span>log_level : <a href="index.html#type-log">log</a> <span>&#45;&gt;</span> <a href="index.html#type-level">level</a></code></dt><dd><p><code>log_level logger</code> returns the currently enabled level for a logger.</p></dd></dl><dl><dt class="spec value" id="val-log_enabled"><a href="#val-log_enabled" class="anchor"></a><code><span class="keyword">val </span>log_enabled : <a href="index.html#type-log">log</a> <span>&#45;&gt;</span> <a href="index.html#type-level">level</a> <span>&#45;&gt;</span> bool</code></dt><dd><p><code>log_enabled logger level</code> returns true if the specified level is currently enabled for the logger.</p></dd></dl></section><section><header><h6 id="log-events"><a href="#log-events" class="anchor"></a>log events</h6></header><dl><dt class="spec type" id="type-event"><a href="#type-event" class="anchor"></a><code><span class="keyword">type </span>event</code><code><span class="keyword"> = </span>string<span class="keyword"> * </span>(string<span class="keyword"> * </span>string) list</code></dt><dd><p>A log <code>event</code> consists of an event name and a list of key-value parameters (an association list). Events are constructed by <code>log</code> when a log level is enabled and passed to log formatters to render them to any logging output stream.</p></dd></dl><dl><dt class="spec value" id="val-log"><a href="#val-log" class="anchor"></a><code><span class="keyword">val </span>log : <a href="index.html#type-log">log</a> <span>&#45;&gt;</span> <a href="index.html#type-level">level</a> <span>&#45;&gt;</span> (unit <span>&#45;&gt;</span> <a href="index.html#type-event">event</a>) <span>&#45;&gt;</span> unit</code></dt><dd><p><code>log logger level event_fun</code> raises a log event if if the specified level is currently enabled for the logger. The function <code>event_fun ()</code> is called to return the event record, and is a function in order to delay construction or formatting of any event parameters in the case where the specified log level is not enabled. For example:</p><pre><code class="ml">log io_log INFO (fun () -&gt; &quot;connect&quot;, [&quot;ADDR&quot;, addr])</code></pre><p>would only log the <code>&quot;connect&quot;</code> event (with the <code>&quot;ADDR&quot;</code> string parameter) when the <code>INFO</code> log level was enabled for the <code>io_log</code> logger.</p></dd></dl><dl><dt class="spec value" id="val-with_log"><a href="#val-with_log" class="anchor"></a><code><span class="keyword">val </span>with_log : <a href="index.html#type-log">log</a> <span>&#45;&gt;</span> <a href="index.html#type-level">level</a> <span>&#45;&gt;</span> (unit <span>&#45;&gt;</span> <a href="index.html#type-event">event</a>) <span>&#45;&gt;</span> ?&#8288;result:(<span class="type-var">'a</span> <span>&#45;&gt;</span> string) <span>&#45;&gt;</span> (unit <span>&#45;&gt;</span> <span class="type-var">'a</span>) <span>&#45;&gt;</span> <span class="type-var">'a</span></code></dt><dd><p><code>with_log logger level event_fun ?result body</code> logs an event before and after calling <code>body ()</code>. The function <code>event_fun ()</code> is called to return the event record to be logged. After the body is evaluated, the <code>result</code> function is used to convert the body's result value into a string, which is added to the event record as a <code>&quot;RESULT&quot;</code> parameter (if no <code>result</code> function is supplied then a <code>&quot;-&quot;</code> is used). In the case where the body raises an exception, an <code>&quot;EXN&quot;</code> parameter is instead added to the event containing the name of the exception. In addition, an indentation level is maintained throughout the duration of the body such that any other log statements occurring inside the body will see an incremented indentation level. This is added to the event key-value arguments as an additional <code>&quot;I&quot;</code> parameter.</p></dd></dl></section><section><header><h6 id="log-formatters"><a href="#log-formatters" class="anchor"></a>log formatters</h6></header><dl><dt class="spec type" id="type-formatter"><a href="#type-formatter" class="anchor"></a><code><span class="keyword">type </span>formatter</code><code><span class="keyword"> = </span><a href="index.html#type-log">log</a> <span>&#45;&gt;</span> <a href="index.html#type-level">level</a> <span>&#45;&gt;</span> <a href="index.html#type-event">event</a> <span>&#45;&gt;</span> float <span>&#45;&gt;</span> unit</code></dt><dd><p>the type of a log formatter is a function that takes the logger, the level of the log statement (which will be the currently enabled level or one of its successors), the event record, and a unix timestamp indicating the time the event was created.</p></dd></dl><dl><dt class="spec value" id="val-register_formatter"><a href="#val-register_formatter" class="anchor"></a><code><span class="keyword">val </span>register_formatter : string <span>&#45;&gt;</span> <a href="index.html#type-formatter">formatter</a> <span>&#45;&gt;</span> unit</code></dt><dd><p><code>register_formatter name formatter</code> registers a named log formatter. The name is only used for subsequent calls to identify the formatter via <code>unregister_formatter</code>.</p></dd></dl><dl><dt class="spec value" id="val-unregister_formatter"><a href="#val-unregister_formatter" class="anchor"></a><code><span class="keyword">val </span>unregister_formatter : string <span>&#45;&gt;</span> unit</code></dt><dd><p><code>unregister_formatter name</code> unregisters a named log formatter.</p></dd></dl><dl><dt class="spec value" id="val-make_std_formatter"><a href="#val-make_std_formatter" class="anchor"></a><code><span class="keyword">val </span>make_std_formatter : <span class="type-var">'a</span> BatIO.output <span>&#45;&gt;</span> <a href="index.html#type-formatter">formatter</a></code></dt><dd><p><code>make_std_formatter oc</code> constructs a formatter from an output channel. This formatter will format log events as tab-separated <code>&lt;keyword&gt;:&lt;value&gt;</code> pairs. The resulting formatter must be registered via <code>register_formatter</code> to be used when events are raised. This formatter also always outputs special parameters that describe the event timestamp (an ISO-8610 timestamp prefixed by <code>&quot;D&quot;</code>), the event name (the log module name followed by a dot, followed by the event name, prefixed by <code>&quot;E&quot;</code>), the log level (prefixed by <code>&quot;L&quot;</code>), the indentation level ( prefixed by <code>&quot;I&quot;</code>), followed by any other event parameters. For example, the log statement:</p><pre><code class="ml">log io_log INFO (fun () -&gt; &quot;connect&quot;, [&quot;ADDR&quot;, addr])</code></pre><p>would produce formatted output like the following when the <code>io_log</code> <code>INFO</code> level was enabled:</p><pre><code class="ml">D:2009-01-26T00:47:45.033329Z   E:io.connect   L:INFO   I:1   ADDR:localhost:8080</code></pre></dd></dl><dl><dt class="spec value" id="val-stderr_formatter"><a href="#val-stderr_formatter" class="anchor"></a><code><span class="keyword">val </span>stderr_formatter : <a href="index.html#type-formatter">formatter</a></code></dt><dd><p><code>stderr_formatter</code> is a standard formatter that outputs log events to stderr using the same format as <code>make_std_formatter</code>. The resulting formatter must be registered via <code>register_formatter</code> or supplied to <code>init</code> or <code>init_from_string</code> to be used when events are raised.</p></dd></dl><dl><dt class="spec value" id="val-null_formatter"><a href="#val-null_formatter" class="anchor"></a><code><span class="keyword">val </span>null_formatter : <a href="index.html#type-formatter">formatter</a></code></dt><dd><p><code>null_formatter</code> is a formatter that does not output any events, but simply discards them.</p></dd></dl><dl><dt class="spec value" id="val-make_dbg_formatter"><a href="#val-make_dbg_formatter" class="anchor"></a><code><span class="keyword">val </span>make_dbg_formatter : <span class="type-var">'a</span> BatIO.output <span>&#45;&gt;</span> <a href="index.html#type-formatter">formatter</a></code></dt><dd><p><code>make_dbg_formatter oc</code> constructs a debug formatter from an output channel. The debug formatter outputs simplified format that is easier to read for debugging purposes and displays indentation level. E.g.:</p><pre><code class="ml">with_log io_log DEBUG (fun () -&gt; &quot;listener&quot; [&quot;ADDR&quot;, addr])
  accept_connections (* calls other log statements *)</code></pre><p>would produce formatted output like the following when the <code>io_log</code> <code>DEBUG</code> level was enabled:</p><pre><code class="ml">### io.listener ADDR:localhost:8080 [DEBUG]
    ### | io.connected CLIENT_ADDR:192.168.0.23:28303 [DEBUG]
    ### | io.disconnected CLIENT_ADDR:192.168.0.23:28303 [DEBUG]
                                                         ...
      ### io.listener ADDR:localhost:8080 RESULT:- [DEBUG]</code></pre></dd></dl><dl><dt class="spec value" id="val-dbg_formatter"><a href="#val-dbg_formatter" class="anchor"></a><code><span class="keyword">val </span>dbg_formatter : <a href="index.html#type-formatter">formatter</a></code></dt><dd><p><code>dbg_formatter</code> is a debug formatter that outputs log events to stderr using the same format as <code>make_dbg_formatter</code>. The resulting formatter must be registered via <code>register_formatter</code> or supplied to <code>init</code> or <code>init_from_string</code> to be used when events are raised.</p></dd></dl></section><section><header><h6 id="logger-initialization"><a href="#logger-initialization" class="anchor"></a>logger initialization</h6></header><dl><dt class="spec value" id="val-init"><a href="#val-init" class="anchor"></a><code><span class="keyword">val </span>init : (string<span class="keyword"> * </span><a href="index.html#type-level">level</a>) list <span>&#45;&gt;</span> <a href="index.html#type-formatter">formatter</a> <span>&#45;&gt;</span> unit</code></dt><dd><p><code>init name_level_list formatter</code> initializes the logging system enabling the specified levels for each named logger. The formatter is the initial formatter for any log events that are output and is registered with the name &quot;default&quot; (other formatters may be registered by <code>register_formatter</code>).</p></dd></dl><dl><dt class="spec value" id="val-init_from_string"><a href="#val-init_from_string" class="anchor"></a><code><span class="keyword">val </span>init_from_string : string <span>&#45;&gt;</span> <a href="index.html#type-formatter">formatter</a> <span>&#45;&gt;</span> unit</code></dt><dd><p><code>init_from_string name_level_string formatter</code> initializes the logging system enabling the specified levels for each named logger. The string must be a comma separated list of <code>&lt;logger
    name&gt;:&lt;level name&gt;</code> pairs, e.g. <code>&quot;FOO:ERROR,BAR:WARN&quot;</code>. If a un-prefixed level name is specified, then that becomes the default log level for all newly created logs, and all currently created logs are enabled to that level. If the logger does not yet exist, it is created. The formatter is the initial formatter for any log events that are output and is registered with the name &quot;default&quot; (other formatters may be registered by <code>register_formatter</code>).</p></dd></dl></section><section><header><h6 id="log-utilities"><a href="#log-utilities" class="anchor"></a>log utilities</h6></header><dl><dt class="spec value" id="val-level_of_name"><a href="#val-level_of_name" class="anchor"></a><code><span class="keyword">val </span>level_of_name : string <span>&#45;&gt;</span> <a href="index.html#type-level">level</a></code></dt><dd><p><code>level_of_name str</code> returns the <code>level</code> associated with <code>str</code>.</p></dd></dl><dl><dt class="spec value" id="val-name_of_level"><a href="#val-name_of_level" class="anchor"></a><code><span class="keyword">val </span>name_of_level : <a href="index.html#type-level">level</a> <span>&#45;&gt;</span> string</code></dt><dd><p><code>name_of_level level</code> returns the name of the specified <code>level</code>.</p></dd></dl><dl><dt class="spec value" id="val-format_timestamp"><a href="#val-format_timestamp" class="anchor"></a><code><span class="keyword">val </span>format_timestamp : <span class="type-var">'a</span> BatIO.output <span>&#45;&gt;</span> float <span>&#45;&gt;</span> unit</code></dt><dd><p><code>format_timestamp oc timestamp</code> prints an ISO-8601 formatted timestamp (extended to specify higher-resolution seconds) to the output channel, <code>oc</code>.</p></dd></dl></section></div></body></html>