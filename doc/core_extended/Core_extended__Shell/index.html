<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Core_extended__Shell (core_extended.Core_extended__Shell)</title><link rel="stylesheet" href="../../_odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">core_extended</a> &#x00BB; Core_extended__Shell</nav><h1>Module <code>Core_extended__Shell</code></h1><nav class="toc"><ul><li><a href="#basic-run-functions">Basic run functions</a></li><li><a href="#dispatch-to-/bin/bash">Dispatch to /bin/bash</a></li><li><a href="#test-dispatches">Test dispatches</a></li><li><a href="#small-helper-commands">Small helper commands</a></li></ul></nav></header><dl><dt class="spec type" id="type-with_process_flags"><a href="#type-with_process_flags" class="anchor"></a><code><span class="keyword">type</span> 'a with_process_flags</code><code> = ?&#8288;use_extra_path:bool <span>&#45;&gt;</span> ?&#8288;timeout:<a href="../../core_kernel/Core_kernel__Time_intf/module-type-S/Time/Span/index.html#type-t">Core.Time.Span.t</a> option <span>&#45;&gt;</span> ?&#8288;working_dir:string <span>&#45;&gt;</span> ?&#8288;setuid:int <span>&#45;&gt;</span> ?&#8288;setgid:int <span>&#45;&gt;</span> ?&#8288;env:[ `Extend of (string * string) list | `Replace of (string * string) list ] <span>&#45;&gt;</span> ?&#8288;verbose:bool <span>&#45;&gt;</span> ?&#8288;echo:bool <span>&#45;&gt;</span> ?&#8288;input:string <span>&#45;&gt;</span> ?&#8288;keep_open:bool <span>&#45;&gt;</span> ?&#8288;tail_len:int <span>&#45;&gt;</span> <span class="type-var">'a</span></code></dt><dd><p>This type is an umbrella type for all the command that dispatch a process. It comes with a list of arguments whose default value can be tweaked by set_defaults.</p><ul><li><code>use_extra_path</code> : if we fail to find the command in the path then we look for it <code>extra_path</code></li><li><code>timeout</code> : the command will raise <code>Failed</code> if the program doesn't do any IO for this period of time</li><li><code>working_dir</code> : run the command in this directory</li><li><code>verbose</code> : prints the output of the command</li><li><code>echo</code> : print out the command before running it</li><li><code>input</code> : a string to pipe through the program's standard in</li><li><code>export</code> : a list of variable to export in the environement of the dispatched program</li><li><code>preserve_euid</code> : pass the '-p' option to bash when running the command; this should disable the default bash behavior of replacing the effective user ID with the current value of the real user ID, useful in programs where privileges are escalated and de-escalated using seteuid(2)</li></ul><p>WARNING: the input argument to this function should not be used because it can deadlock if the input is too big (~160kb?)</p></dd></dl><dl><dt class="spec type" id="type-with_run_flags"><a href="#type-with_run_flags" class="anchor"></a><code><span class="keyword">type</span> 'a with_run_flags</code><code> = ?&#8288;expect:int list <span>&#45;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-with_process_flags">with_process_flags</a></code></dt><dd><p>This is the list of flags for normal process dispatch. It is an extension of <code>with_process_flags</code>.</p><ul><li><code>expect</code> : an int list of valid return codes. default value is <code>[0]</code>, if the return code of the dispatched is not in this list we will blowup with <code>Process.Failure</code></li></ul></dd></dl><section><header><h6 id="basic-run-functions"><a href="#basic-run-functions" class="anchor"></a>Basic run functions</h6><p>In all the functions below the command is specified with two arguments. The first one is a string representing the process to run. The second one is the list of arguments to pass.</p><p>Although the arguments do not need to be escaped there is still a risk that they might be interpreted as flags when they aren't. Most basic unix utilities provide the ability to pass arguments after &quot;--&quot; to avoid this.</p><p>Usage example:</p><pre><code class="ml">let patch = run_full ~expect:[0;1] &quot;diff&quot; [&quot;-u&quot;;&quot;--&quot;;file1;file2]</code></pre></header><dl><dt class="spec type" id="type-cmd"><a href="#type-cmd" class="anchor"></a><code><span class="keyword">type</span> 'a cmd</code><code> = string <span>&#45;&gt;</span> string list <span>&#45;&gt;</span> <span class="type-var">'a</span></code></dt></dl><dl><dt class="spec value" id="val-run"><a href="#val-run" class="anchor"></a><code><span class="keyword">val</span> run : unit <a href="index.html#type-cmd">cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a></code></dt><dd><p>Runs a command and discards its output.</p></dd></dl><dl><dt class="spec value" id="val-run_lines"><a href="#val-run_lines" class="anchor"></a><code><span class="keyword">val</span> run_lines : ?&#8288;eol:char <span>&#45;&gt;</span> string list <a href="index.html#type-cmd">cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a></code></dt><dd><p>Runs a command and returns its output line separated. Note: most commands print a newline at the end of their output so the shell prompt appears on its own line. If the output ends in a newline, it is stripped before splitting the output into a string list to avoid there being a final element in the list containing just the empty string.</p><p>In some cases, the newline should not be stripped (e.g., &quot;cat&quot; will not &quot;add&quot; a newline). If you care, use <code>run_full</code> for the entire buffer.</p></dd></dl><dl><dt class="spec value" id="val-run_first_line"><a href="#val-run_first_line" class="anchor"></a><code><span class="keyword">val</span> run_first_line : ?&#8288;eol:char <span>&#45;&gt;</span> string option <a href="index.html#type-cmd">cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a></code></dt><dd><p>Returns the first line of the command's output.</p><p>This function might terminate the program early the same way that piping through <code>head -n 1</code> would. When that happens, exit code of the program gets ignored!</p></dd></dl><dl><dt class="spec value" id="val-run_first_line_exn"><a href="#val-run_first_line_exn" class="anchor"></a><code><span class="keyword">val</span> run_first_line_exn : ?&#8288;eol:char <span>&#45;&gt;</span> string <a href="index.html#type-cmd">cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a></code></dt><dt class="spec value" id="val-run_one_line"><a href="#val-run_one_line" class="anchor"></a><code><span class="keyword">val</span> run_one_line : ?&#8288;eol:char <span>&#45;&gt;</span> string <a href="../../core_kernel/Core_kernel/Or_error/index.html#type-t">Core.Or_error.t</a> <a href="index.html#type-cmd">cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a></code></dt><dd><p>Returns the only line of the command's output. If the command prints zero or multiple lines this returns an <code>Error</code>.</p><p>If the command exits with non-zero exit code it raises an exception.</p></dd></dl><dl><dt class="spec value" id="val-run_one_line_exn"><a href="#val-run_one_line_exn" class="anchor"></a><code><span class="keyword">val</span> run_one_line_exn : ?&#8288;eol:char <span>&#45;&gt;</span> string <a href="index.html#type-cmd">cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a></code></dt><dt class="spec value" id="val-run_one"><a href="#val-run_one" class="anchor"></a><code><span class="keyword">val</span> run_one : ?&#8288;eol:char <span>&#45;&gt;</span> string option <a href="index.html#type-cmd">cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a></code></dt><dt class="spec value" id="val-run_one_exn"><a href="#val-run_one_exn" class="anchor"></a><code><span class="keyword">val</span> run_one_exn : ?&#8288;eol:char <span>&#45;&gt;</span> string <a href="index.html#type-cmd">cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a></code></dt><dt class="spec value" id="val-run_full"><a href="#val-run_full" class="anchor"></a><code><span class="keyword">val</span> run_full : string <a href="index.html#type-cmd">cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a></code></dt><dd><p>Return the full command's output in one string. See the note in <code>run_lines</code>.</p></dd></dl><dl><dt class="spec value" id="val-run_fold"><a href="#val-run_fold" class="anchor"></a><code><span class="keyword">val</span> run_fold : ?&#8288;eol:char <span>&#45;&gt;</span> init:<span class="type-var">'a</span> <span>&#45;&gt;</span> f:(<span class="type-var">'a</span> <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <span class="type-var">'a</span> * [ `Continue | `Stop ]) <span>&#45;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-cmd">cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a></code></dt><dd><p>Fold over the lines in the stdout of a process; The `Continue/`Stop argument is there to allow early returning. <code>eol</code> specifies the end of line character used to separate the lines outputted by the the program</p></dd></dl></section><section><header><h6 id="dispatch-to-/bin/bash"><a href="#dispatch-to-/bin/bash" class="anchor"></a>Dispatch to /bin/bash</h6><p>All these function take a format (like printf) and run it through the shell.</p><p>Usage example:</p><pre><code class="ml">sh &quot;cp -- %s %s&quot; (Filename.quote file1)  (Filename.quote file2)</code></pre><p>In general it is recommended to avoid using those too much and to prefer the run* family of function instead because it avoids pitfall like escaping issues and is much more straightforward to think about.</p></header><dl><dt class="spec type" id="type-sh_cmd"><a href="#type-sh_cmd" class="anchor"></a><code><span class="keyword">type</span> ('a, 'ret) sh_cmd</code><code> = (<span class="type-var">'a</span>,Â unit,Â string,Â <span class="type-var">'ret</span>) <a href="../../core/Core/index.html#type-format4">Core.format4</a> <span>&#45;&gt;</span> <span class="type-var">'a</span></code></dt></dl><dl><dt class="spec value" id="val-sh"><a href="#val-sh" class="anchor"></a><code><span class="keyword">val</span> sh : (<span class="type-var">'a</span>,Â unit) <a href="index.html#type-sh_cmd">sh_cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a></code></dt><dt class="spec value" id="val-sh_lines"><a href="#val-sh_lines" class="anchor"></a><code><span class="keyword">val</span> sh_lines : (<span class="type-var">'a</span>,Â string list) <a href="index.html#type-sh_cmd">sh_cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a></code></dt><dt class="spec value" id="val-sh_full"><a href="#val-sh_full" class="anchor"></a><code><span class="keyword">val</span> sh_full : (<span class="type-var">'a</span>,Â string) <a href="index.html#type-sh_cmd">sh_cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a></code></dt><dt class="spec value" id="val-sh_one"><a href="#val-sh_one" class="anchor"></a><code><span class="keyword">val</span> sh_one : (<span class="type-var">'a</span>,Â string option) <a href="index.html#type-sh_cmd">sh_cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a></code></dt><dt class="spec value" id="val-sh_one_exn"><a href="#val-sh_one_exn" class="anchor"></a><code><span class="keyword">val</span> sh_one_exn : (<span class="type-var">'a</span>,Â string) <a href="index.html#type-sh_cmd">sh_cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a></code></dt><dt class="spec value" id="val-sh_one_line"><a href="#val-sh_one_line" class="anchor"></a><code><span class="keyword">val</span> sh_one_line : (<span class="type-var">'a</span>,Â string <a href="../../core_kernel/Core_kernel/Or_error/index.html#type-t">Core.Or_error.t</a>) <a href="index.html#type-sh_cmd">sh_cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a></code></dt><dt class="spec value" id="val-sh_one_line_exn"><a href="#val-sh_one_line_exn" class="anchor"></a><code><span class="keyword">val</span> sh_one_line_exn : (<span class="type-var">'a</span>,Â string) <a href="index.html#type-sh_cmd">sh_cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a></code></dt><dt class="spec value" id="val-sh_first_line"><a href="#val-sh_first_line" class="anchor"></a><code><span class="keyword">val</span> sh_first_line : (<span class="type-var">'a</span>,Â string option) <a href="index.html#type-sh_cmd">sh_cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a></code></dt><dt class="spec value" id="val-sh_first_line_exn"><a href="#val-sh_first_line_exn" class="anchor"></a><code><span class="keyword">val</span> sh_first_line_exn : (<span class="type-var">'a</span>,Â string) <a href="index.html#type-sh_cmd">sh_cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a></code></dt><dt class="spec value" id="val-noninteractive_ssh_options"><a href="#val-noninteractive_ssh_options" class="anchor"></a><code><span class="keyword">val</span> noninteractive_ssh_options : string list</code></dt><dt class="spec value" id="val-noninteractive_no_hostkey_checking_options"><a href="#val-noninteractive_no_hostkey_checking_options" class="anchor"></a><code><span class="keyword">val</span> noninteractive_no_hostkey_checking_options : string list</code></dt></dl><dl><dt class="spec type" id="type-with_ssh_flags"><a href="#type-with_ssh_flags" class="anchor"></a><code><span class="keyword">type</span> 'a with_ssh_flags</code><code> = ?&#8288;ssh_options:string list <span>&#45;&gt;</span> ?&#8288;user:string <span>&#45;&gt;</span> host:string <span>&#45;&gt;</span> <span class="type-var">'a</span></code></dt></dl><dl><dt class="spec value" id="val-ssh"><a href="#val-ssh" class="anchor"></a><code><span class="keyword">val</span> ssh : (<span class="type-var">'a</span>,Â unit) <a href="index.html#type-sh_cmd">sh_cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a> <a href="index.html#type-with_ssh_flags">with_ssh_flags</a></code></dt><dt class="spec value" id="val-ssh_lines"><a href="#val-ssh_lines" class="anchor"></a><code><span class="keyword">val</span> ssh_lines : (<span class="type-var">'a</span>,Â string list) <a href="index.html#type-sh_cmd">sh_cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a> <a href="index.html#type-with_ssh_flags">with_ssh_flags</a></code></dt><dt class="spec value" id="val-ssh_full"><a href="#val-ssh_full" class="anchor"></a><code><span class="keyword">val</span> ssh_full : (<span class="type-var">'a</span>,Â string) <a href="index.html#type-sh_cmd">sh_cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a> <a href="index.html#type-with_ssh_flags">with_ssh_flags</a></code></dt><dt class="spec value" id="val-ssh_one"><a href="#val-ssh_one" class="anchor"></a><code><span class="keyword">val</span> ssh_one : (<span class="type-var">'a</span>,Â string option) <a href="index.html#type-sh_cmd">sh_cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a> <a href="index.html#type-with_ssh_flags">with_ssh_flags</a></code></dt><dt class="spec value" id="val-ssh_one_exn"><a href="#val-ssh_one_exn" class="anchor"></a><code><span class="keyword">val</span> ssh_one_exn : (<span class="type-var">'a</span>,Â string) <a href="index.html#type-sh_cmd">sh_cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a> <a href="index.html#type-with_ssh_flags">with_ssh_flags</a></code></dt><dt class="spec value" id="val-ssh_one_line"><a href="#val-ssh_one_line" class="anchor"></a><code><span class="keyword">val</span> ssh_one_line : (<span class="type-var">'a</span>,Â string <a href="../../core_kernel/Core_kernel/Or_error/index.html#type-t">Core.Or_error.t</a>) <a href="index.html#type-sh_cmd">sh_cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a> <a href="index.html#type-with_ssh_flags">with_ssh_flags</a></code></dt><dt class="spec value" id="val-ssh_one_line_exn"><a href="#val-ssh_one_line_exn" class="anchor"></a><code><span class="keyword">val</span> ssh_one_line_exn : (<span class="type-var">'a</span>,Â string) <a href="index.html#type-sh_cmd">sh_cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a> <a href="index.html#type-with_ssh_flags">with_ssh_flags</a></code></dt><dt class="spec value" id="val-ssh_first_line"><a href="#val-ssh_first_line" class="anchor"></a><code><span class="keyword">val</span> ssh_first_line : (<span class="type-var">'a</span>,Â string option) <a href="index.html#type-sh_cmd">sh_cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a> <a href="index.html#type-with_ssh_flags">with_ssh_flags</a></code></dt><dt class="spec value" id="val-ssh_first_line_exn"><a href="#val-ssh_first_line_exn" class="anchor"></a><code><span class="keyword">val</span> ssh_first_line_exn : (<span class="type-var">'a</span>,Â string) <a href="index.html#type-sh_cmd">sh_cmd</a> <a href="index.html#type-with_run_flags">with_run_flags</a> <a href="index.html#type-with_ssh_flags">with_ssh_flags</a></code></dt></dl></section><section><header><h6 id="test-dispatches"><a href="#test-dispatches" class="anchor"></a>Test dispatches</h6><p>Usage example:</p><pre><code class="ml">if Shell.test &quot;diff&quot; [&quot;-q&quot;;&quot;--&quot;;file1;file2] then
   Printf.printf &quot;Files %S and %S are the same\n%!&quot; file1 file2;</code></pre></header><dl><dt class="spec type" id="type-with_test_flags"><a href="#type-with_test_flags" class="anchor"></a><code><span class="keyword">type</span> 'a with_test_flags</code><code> = ?&#8288;true_v:int list <span>&#45;&gt;</span> ?&#8288;false_v:int list <span>&#45;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-with_process_flags">with_process_flags</a></code></dt><dd><p>This is the list of flags for dispatching processes in test mode. This is used to test the return code of the dispatched program. The return value of these functions will be :</p><ul><li><code>true</code> if the exit code is in <code>true_v</code>.</li><li><code>false</code> if the exit code is in <code>false_v</code> and not in <code>true_v</code>.</li><li>Raises <code>Process.Failure</code> otherwise</li></ul><p>The default values are:</p><ul><li><code>true_v</code>: default value <code>[0]</code></li><li><code>false_v</code>: default_value <code>[1]</code></li></ul></dd></dl><dl><dt class="spec value" id="val-test"><a href="#val-test" class="anchor"></a><code><span class="keyword">val</span> test : bool <a href="index.html#type-cmd">cmd</a> <a href="index.html#type-with_test_flags">with_test_flags</a></code></dt><dt class="spec value" id="val-sh_test"><a href="#val-sh_test" class="anchor"></a><code><span class="keyword">val</span> sh_test : (<span class="type-var">'a</span>,Â bool) <a href="index.html#type-sh_cmd">sh_cmd</a> <a href="index.html#type-with_test_flags">with_test_flags</a></code></dt><dt class="spec value" id="val-ssh_test"><a href="#val-ssh_test" class="anchor"></a><code><span class="keyword">val</span> ssh_test : (<span class="type-var">'a</span>,Â bool) <a href="index.html#type-sh_cmd">sh_cmd</a> <a href="index.html#type-with_test_flags">with_test_flags</a> <a href="index.html#type-with_ssh_flags">with_ssh_flags</a></code></dt><dt class="spec value" id="val-extra_path"><a href="#val-extra_path" class="anchor"></a><code><span class="keyword">val</span> extra_path : string list <a href="../../core/Core/index.html#type-ref">Core.ref</a></code></dt><dd><p>variable used by dispatch command to find binaries not in the path. The default values contains only directory which should be in PATH and is only useful in environments where the PATH variable has been blown away.</p></dd></dl><dl><dt class="spec module" id="module-Process"><a href="#module-Process" class="anchor"></a><code><span class="keyword">module</span> <a href="Process/index.html">Process</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>Process dispatching</p></dd></dl></section><section><header><h6 id="small-helper-commands"><a href="#small-helper-commands" class="anchor"></a>Small helper commands</h6></header><dl><dt class="spec value" id="val-mkdir"><a href="#val-mkdir" class="anchor"></a><code><span class="keyword">val</span> mkdir : ?&#8288;p:unit <span>&#45;&gt;</span> ?&#8288;perm:int <span>&#45;&gt;</span> string <span>&#45;&gt;</span> unit</code></dt><dt class="spec value" id="val-cp"><a href="#val-cp" class="anchor"></a><code><span class="keyword">val</span> cp : ?&#8288;overwrite:bool <span>&#45;&gt;</span> ?&#8288;perm:<a href="../../core/Core__/Core_unix/index.html#type-file_perm">Core.Unix.file_perm</a> <span>&#45;&gt;</span> string <span>&#45;&gt;</span> string <span>&#45;&gt;</span> unit</code></dt><dt class="spec value" id="val-ln"><a href="#val-ln" class="anchor"></a><code><span class="keyword">val</span> ln : ?&#8288;s:unit <span>&#45;&gt;</span> ?&#8288;f:unit <span>&#45;&gt;</span> string <span>&#45;&gt;</span> string <span>&#45;&gt;</span> unit</code></dt><dt class="spec value" id="val-rm"><a href="#val-rm" class="anchor"></a><code><span class="keyword">val</span> rm : ?&#8288;r:unit <span>&#45;&gt;</span> ?&#8288;f:unit <span>&#45;&gt;</span> string <span>&#45;&gt;</span> unit</code></dt><dt class="spec value" id="val-mv"><a href="#val-mv" class="anchor"></a><code><span class="keyword">val</span> mv : string <span>&#45;&gt;</span> string <span>&#45;&gt;</span> unit</code></dt><dd><p>Raises &quot;Failed_command&quot;</p></dd></dl><dl><dt class="spec value" id="val-whoami"><a href="#val-whoami" class="anchor"></a><code><span class="keyword">val</span> whoami : ?&#8288;real:bool <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> string</code></dt><dd><p>Get the username. By default, the effective username. If real is true, get the real username.</p></dd></dl><dl><dt class="spec value" id="val-which"><a href="#val-which" class="anchor"></a><code><span class="keyword">val</span> which : ?&#8288;use_extra_path:bool <span>&#45;&gt;</span> string <span>&#45;&gt;</span> string option</code></dt><dt class="spec value" id="val-scp"><a href="#val-scp" class="anchor"></a><code><span class="keyword">val</span> scp : ?&#8288;compress:bool <span>&#45;&gt;</span> ?&#8288;recurse:bool <span>&#45;&gt;</span> ?&#8288;user:string <span>&#45;&gt;</span> host:string <span>&#45;&gt;</span> string <span>&#45;&gt;</span> string <span>&#45;&gt;</span> unit</code></dt><dd><p><code>scp user host from to</code> copy local file from to to</p></dd></dl></section></div></body></html>