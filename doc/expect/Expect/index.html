<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Expect (expect.Expect)</title><link rel="stylesheet" href="../../_odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">expect</a> &#x00BB; Expect</nav><h1>Module <code>Expect</code></h1><p>Expect module for testing interactive program.</p><p>This is a simple implementation of expect to help building unitary testing of interactive program. Since this is an OCaml library, only specific part of expect has been implemented. Other function can be replaced by standard OCaml functions (exit...).</p><p>The use of this library is built around 4 functions:</p><ul><li>spawn: to create a process</li><li>send: to send a string to the process</li><li>expect: match output of the process</li><li>close: end the process</li></ul><p>Output of the program is processed line by line.</p><p>Regular expression is implemented through the library Str. You will need to build a regexp using this module. The regexp should only match a substring of the line. If you need to match something at the beginning or at the end, use &quot;^&quot; and &quot;$&quot;. To use a regexp</p><p>Additional match functions can be build using a standard function. This function is passed the entire line and should return if it match or not.</p><p>There is two additional event to match:</p><ul><li>eof: process close its output</li><li>timeout: too much time has been spent waiting to match something</li></ul><p>Both of this action, if not matched will use the default_action provided.</p><p>Here is an example program, that look for string &quot;.&quot; in the output:</p><pre><code class="ml">open Expect

let (), exit_code =
  with_spawn &quot;ls&quot; [|&quot;-alh&quot;|]
  (fun t () -&gt;
    if expect t [`Exact &quot;.&quot;, true] false then
      prerr_endline &quot;'.' found&quot;
    else
      prerr_endline &quot;'.' not found&quot;)
  ()
in
  match exit_code with
  | Unix.WEXITED 0 -&gt;
      print_endline &quot;Exit normal&quot;
  | _ -&gt;
      print_endline &quot;Problem when exiting&quot;</code></pre><p>See <a href="http://directory.fsf.org/project/expect/">Expect manual</a></p><dl><dt>author</dt><dd>Sylvain Le Gall</dd></dl></header><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> t</code></dt><dd><p>A process under the monitoring of Expect.</p></dd></dl><dl><dt class="spec type" id="type-expect_match"><a href="#type-expect_match" class="anchor"></a><code><span class="keyword">type</span> expect_match</code> = <code>[ </code><table class="variant"><tr id="type-expect_match.Eof" class="anchored"><td class="def constructor"><a href="#type-expect_match.Eof" class="anchor"></a><code>| </code><code>`Eof</code></td><td class="doc"><p>Look for EOF</p></td></tr><tr id="type-expect_match.Fun" class="anchored"><td class="def constructor"><a href="#type-expect_match.Fun" class="anchor"></a><code>| </code><code>`Fun <span class="keyword">of</span> string <span>&#45;&gt;</span> bool</code></td><td class="doc"><p>Look for a line matching the string</p></td></tr><tr id="type-expect_match.Exact" class="anchored"><td class="def constructor"><a href="#type-expect_match.Exact" class="anchor"></a><code>| </code><code>`Exact <span class="keyword">of</span> string</code></td><td class="doc"><p>Look for a line matching exactly this string</p></td></tr><tr id="type-expect_match.Suffix" class="anchored"><td class="def constructor"><a href="#type-expect_match.Suffix" class="anchor"></a><code>| </code><code>`Suffix <span class="keyword">of</span> string</code></td><td class="doc"><p>Look for a line ending with this string</p></td></tr><tr id="type-expect_match.Prefix" class="anchored"><td class="def constructor"><a href="#type-expect_match.Prefix" class="anchor"></a><code>| </code><code>`Prefix <span class="keyword">of</span> string</code></td><td class="doc"><p>Look for a line starting with this string</p></td></tr><tr id="type-expect_match.Contains" class="anchored"><td class="def constructor"><a href="#type-expect_match.Contains" class="anchor"></a><code>| </code><code>`Contains <span class="keyword">of</span> string</code></td><td class="doc"><p>Look for a line containing this string</p></td></tr><tr id="type-expect_match.Timeout" class="anchored"><td class="def constructor"><a href="#type-expect_match.Timeout" class="anchor"></a><code>| </code><code>`Timeout</code></td></tr></table><code> ]</code></dt><dd><p>Describe expectation about the output of the process. Lines includes the EOL (i.e. \n).</p></dd></dl><dl><dt class="spec value" id="val-spawn"><a href="#val-spawn" class="anchor"></a><code><span class="keyword">val</span> spawn : ?&#8288;verbose:bool <span>&#45;&gt;</span> ?&#8288;verbose_output:(string <span>&#45;&gt;</span> unit) <span>&#45;&gt;</span> ?&#8288;timeout:float option <span>&#45;&gt;</span> ?&#8288;env:string array <span>&#45;&gt;</span> ?&#8288;use_stderr:bool <span>&#45;&gt;</span> string <span>&#45;&gt;</span> string array <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dd><p><code>spawn prg args</code> Start a process and monitor its output. Contrary to <code>Unix.create_process</code>, you don't need to repeat the program name at the beginning of args.</p><p>Optional parameters:</p><ul><li><code>~timeout</code>: define the default timeout, in seconds. None means that you can wait forever</li><li><code>~env</code>: provide environment to run the process</li><li><code>~use_stderr</code>: redirect stderr to stdout and process it through expect</li></ul></dd></dl><dl><dt class="spec value" id="val-set_timeout"><a href="#val-set_timeout" class="anchor"></a><code><span class="keyword">val</span> set_timeout : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> float option <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dd><p>Define the timeout for a process.</p></dd></dl><dl><dt class="spec value" id="val-send"><a href="#val-send" class="anchor"></a><code><span class="keyword">val</span> send : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> string <span>&#45;&gt;</span> unit</code></dt><dd><p>Send a string to a process.</p></dd></dl><dl><dt class="spec value" id="val-expect"><a href="#val-expect" class="anchor"></a><code><span class="keyword">val</span> expect : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> ?&#8288;fmatches:(string <span>&#45;&gt;</span> <span class="type-var">'a</span> option) list <span>&#45;&gt;</span> (<a href="index.html#type-expect_match">expect_match</a> * <span class="type-var">'a</span>) list <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> <span class="type-var">'a</span></code></dt><dd><p><code>expect t ~fmatches matches dflt</code> Waits for output of the process and match it against expectations <code>matches</code>. If no expectations match at timeout, returns <code>dflt</code>. You can use <code>~fmatch</code> to define while processing the output what the result is, if you find a match, return <code>Some res</code> otherwise return <code>None</code>. The function take into account <code>matches</code> before <code>~fmatch</code> and it picks the first result which is not <code>None</code>.</p></dd></dl><dl><dt class="spec value" id="val-close"><a href="#val-close" class="anchor"></a><code><span class="keyword">val</span> close : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../ocaml/Unix/index.html#type-process_status">Unix.process_status</a></code></dt><dd><p>Close the process.</p></dd></dl><dl><dt class="spec value" id="val-with_spawn"><a href="#val-with_spawn" class="anchor"></a><code><span class="keyword">val</span> with_spawn : ?&#8288;verbose:bool <span>&#45;&gt;</span> ?&#8288;verbose_output:(string <span>&#45;&gt;</span> unit) <span>&#45;&gt;</span> ?&#8288;timeout:float option <span>&#45;&gt;</span> ?&#8288;env:string array <span>&#45;&gt;</span> ?&#8288;use_stderr:bool <span>&#45;&gt;</span> string <span>&#45;&gt;</span> string array <span>&#45;&gt;</span> (<a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> <span class="type-var">'a</span>) <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> <span class="type-var">'a</span> * <a href="../../ocaml/Unix/index.html#type-process_status">Unix.process_status</a></code></dt><dd><p>Take care of opening and closing the process.</p></dd></dl></div></body></html>