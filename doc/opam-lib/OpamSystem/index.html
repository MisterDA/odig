<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>OpamSystem (opam-lib.OpamSystem)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../index.html">opam-lib</a> &#x00BB; OpamSystem</nav><h1>Module <code>OpamSystem</code></h1><p>Low-level untyped system operations</p><nav class="toc"><ul><li><a href="#file-locking-function">File locking function</a></li><li><a href="#misc">Misc</a></li></ul></nav></header><dl><dt class="spec exception" id="exception-Process_error"><a href="#exception-Process_error" class="anchor"></a><code><span class="keyword">exception </span></code><code><span class="exception">Process_error</span><span class="keyword"> of </span>OpamProcess.result</code></dt><dd><p>Exception raised when subprocess fails</p></dd></dl><dl><dt class="spec exception" id="exception-Command_not_found"><a href="#exception-Command_not_found" class="anchor"></a><code><span class="keyword">exception </span></code><code><span class="exception">Command_not_found</span><span class="keyword"> of </span>string</code></dt></dl><dl><dt class="spec value" id="val-process_error"><a href="#val-process_error" class="anchor"></a><code><span class="keyword">val </span>process_error : OpamProcess.result <span>&#45;&gt;</span> <span class="type-var">'a</span></code></dt><dd><p>raise <code>Process_error</code></p></dd></dl><dl><dt class="spec value" id="val-raise_on_process_error"><a href="#val-raise_on_process_error" class="anchor"></a><code><span class="keyword">val </span>raise_on_process_error : OpamProcess.result <span>&#45;&gt;</span> unit</code></dt><dd><p>raise <code>Process_error</code> if the process didn't return 0</p></dd></dl><dl><dt class="spec exception" id="exception-Internal_error"><a href="#exception-Internal_error" class="anchor"></a><code><span class="keyword">exception </span></code><code><span class="exception">Internal_error</span><span class="keyword"> of </span>string</code></dt><dd><p>Exception raised when a computation in the current process fails.</p></dd></dl><dl><dt class="spec value" id="val-internal_error"><a href="#val-internal_error" class="anchor"></a><code><span class="keyword">val </span>internal_error : (<span class="type-var">'a</span>, unit, string, <span class="type-var">'b</span>) Pervasives.format4 <span>&#45;&gt;</span> <span class="type-var">'a</span></code></dt><dd><p>Raise <code>Internal_error</code></p></dd></dl><dl><dt class="spec value" id="val-with_tmp_dir"><a href="#val-with_tmp_dir" class="anchor"></a><code><span class="keyword">val </span>with_tmp_dir : (string <span>&#45;&gt;</span> <span class="type-var">'a</span>) <span>&#45;&gt;</span> <span class="type-var">'a</span></code></dt><dd><p><code>with_tmp_dir fn</code> executes <code>fn</code> in a tempory directory</p></dd></dl><dl><dt class="spec value" id="val-with_tmp_dir_job"><a href="#val-with_tmp_dir_job" class="anchor"></a><code><span class="keyword">val </span>with_tmp_dir_job : (string <span>&#45;&gt;</span> <span class="type-var">'a</span> OpamProcess.job) <span>&#45;&gt;</span> <span class="type-var">'a</span> OpamProcess.job</code></dt><dd><p>Runs a job with a temp dir that is cleaned up afterwards</p></dd></dl><dl><dt class="spec value" id="val-verbose_for_base_commands"><a href="#val-verbose_for_base_commands" class="anchor"></a><code><span class="keyword">val </span>verbose_for_base_commands : unit <span>&#45;&gt;</span> bool</code></dt><dd><p>Returns true if the default verbose level for base commands (cp, mv, etc.) is reached</p></dd></dl><dl><dt class="spec value" id="val-copy"><a href="#val-copy" class="anchor"></a><code><span class="keyword">val </span>copy : string <span>&#45;&gt;</span> string <span>&#45;&gt;</span> unit</code></dt><dd><p><code>copy src dst</code> copies <code>src</code> to <code>dst</code>. Remove <code>dst</code> before the copy if it is a link.</p></dd></dl><dl><dt class="spec value" id="val-mv"><a href="#val-mv" class="anchor"></a><code><span class="keyword">val </span>mv : string <span>&#45;&gt;</span> string <span>&#45;&gt;</span> unit</code></dt><dt class="spec value" id="val-install"><a href="#val-install" class="anchor"></a><code><span class="keyword">val </span>install : ?&#8288;exec:bool <span>&#45;&gt;</span> string <span>&#45;&gt;</span> string <span>&#45;&gt;</span> unit</code></dt><dd><p><code>install ?exec src dst</code> copies file <code>src</code> as file <code>dst</code> using <code>install</code>. If <code>exec</code>, make the resulting file executable (otherwise, look at the permissions of the original file to decide).</p></dd></dl><dl><dt class="spec value" id="val-is_exec"><a href="#val-is_exec" class="anchor"></a><code><span class="keyword">val </span>is_exec : string <span>&#45;&gt;</span> bool</code></dt><dd><p>Checks if a file is an executable (regular file with execution permission)</p></dd></dl><dl><dt class="spec value" id="val-link"><a href="#val-link" class="anchor"></a><code><span class="keyword">val </span>link : string <span>&#45;&gt;</span> string <span>&#45;&gt;</span> unit</code></dt><dd><p><code>link src dst</code> links <code>src</code> to <code>dst</code>. Remove <code>dst</code> if it is a file, not a directory.</p></dd></dl><dl><dt class="spec value" id="val-real_path"><a href="#val-real_path" class="anchor"></a><code><span class="keyword">val </span>real_path : string <span>&#45;&gt;</span> string</code></dt><dd><p><code>real_path p</code> returns the real path associated to <code>p</code>: <code>..</code> are expanded and relative paths become absolute.</p></dd></dl><dl><dt class="spec value" id="val-string_of_channel"><a href="#val-string_of_channel" class="anchor"></a><code><span class="keyword">val </span>string_of_channel : Pervasives.in_channel <span>&#45;&gt;</span> string</code></dt><dd><p>Return the contents of a channel.</p></dd></dl><dl><dt class="spec exception" id="exception-File_not_found"><a href="#exception-File_not_found" class="anchor"></a><code><span class="keyword">exception </span></code><code><span class="exception">File_not_found</span><span class="keyword"> of </span>string</code></dt><dd><p>Raised when a file or directory can't be accessed (doesn't exist, bad permissions, etc.)</p></dd></dl><dl><dt class="spec value" id="val-read"><a href="#val-read" class="anchor"></a><code><span class="keyword">val </span>read : string <span>&#45;&gt;</span> string</code></dt><dd><p><code>read filename</code> returns the contents of <code>filename</code></p></dd></dl><dl><dt class="spec value" id="val-write"><a href="#val-write" class="anchor"></a><code><span class="keyword">val </span>write : string <span>&#45;&gt;</span> string <span>&#45;&gt;</span> unit</code></dt><dd><p><code>write filename contents</code> write <code>contents</code> to <code>filename</code></p></dd></dl><dl><dt class="spec value" id="val-remove"><a href="#val-remove" class="anchor"></a><code><span class="keyword">val </span>remove : string <span>&#45;&gt;</span> unit</code></dt><dd><p><code>remove filename</code> removes <code>filename</code>. Works whether <code>filename</code> is a file or a directory</p></dd></dl><dl><dt class="spec value" id="val-remove_file"><a href="#val-remove_file" class="anchor"></a><code><span class="keyword">val </span>remove_file : string <span>&#45;&gt;</span> unit</code></dt><dd><p><code>remove_file filename</code> removes <code>filename</code>. Works only for normal files (or also at least for symlinks)</p></dd></dl><dl><dt class="spec value" id="val-remove_dir"><a href="#val-remove_dir" class="anchor"></a><code><span class="keyword">val </span>remove_dir : string <span>&#45;&gt;</span> unit</code></dt><dd><p><code>remove_dir filename</code> removes <code>filename</code>. Works only for directory (not for symlinks or other files).</p></dd></dl><dl><dt class="spec value" id="val-chdir"><a href="#val-chdir" class="anchor"></a><code><span class="keyword">val </span>chdir : string <span>&#45;&gt;</span> unit</code></dt><dd><p>Change the current working directory</p></dd></dl><dl><dt class="spec value" id="val-in_dir"><a href="#val-in_dir" class="anchor"></a><code><span class="keyword">val </span>in_dir : string <span>&#45;&gt;</span> (unit <span>&#45;&gt;</span> <span class="type-var">'a</span>) <span>&#45;&gt;</span> <span class="type-var">'a</span></code></dt><dd><p><code>in_dir dir fn</code> evaluates <code>fn</code> in the directory <code>dir</code></p></dd></dl><dl><dt class="spec value" id="val-files_with_links"><a href="#val-files_with_links" class="anchor"></a><code><span class="keyword">val </span>files_with_links : string <span>&#45;&gt;</span> string list</code></dt><dd><p><code>files_with_links dir</code> returns the files in the directory <code>dir</code>. Links simulating directory are ignored, others links are returned.</p></dd></dl><dl><dt class="spec value" id="val-rec_files"><a href="#val-rec_files" class="anchor"></a><code><span class="keyword">val </span>rec_files : string <span>&#45;&gt;</span> string list</code></dt><dd><p><code>rec_files dir</code> returns the list of all files in <code>dir</code>, recursively. Links behaving like directory are crossed.</p></dd></dl><dl><dt class="spec value" id="val-files"><a href="#val-files" class="anchor"></a><code><span class="keyword">val </span>files : string <span>&#45;&gt;</span> string list</code></dt><dd><p>Return the list of files in the current directory.</p></dd></dl><dl><dt class="spec value" id="val-rec_dirs"><a href="#val-rec_dirs" class="anchor"></a><code><span class="keyword">val </span>rec_dirs : string <span>&#45;&gt;</span> string list</code></dt><dd><p><code>rec_dirs dir</code> return the list list of all directories recursively (going through symbolink links).</p></dd></dl><dl><dt class="spec value" id="val-dirs"><a href="#val-dirs" class="anchor"></a><code><span class="keyword">val </span>dirs : string <span>&#45;&gt;</span> string list</code></dt><dd><p>Return the list of directories in the current directory.</p></dd></dl><dl><dt class="spec value" id="val-dir_is_empty"><a href="#val-dir_is_empty" class="anchor"></a><code><span class="keyword">val </span>dir_is_empty : string <span>&#45;&gt;</span> bool</code></dt><dt class="spec value" id="val-directories_with_links"><a href="#val-directories_with_links" class="anchor"></a><code><span class="keyword">val </span>directories_with_links : string <span>&#45;&gt;</span> string list</code></dt><dd><p><code>directories_with_links dir</code> returns the directories in the directory <code>dir</code>. Links pointing to directory are also returned.</p></dd></dl><dl><dt class="spec value" id="val-make_command"><a href="#val-make_command" class="anchor"></a><code><span class="keyword">val </span>make_command : ?&#8288;verbose:bool <span>&#45;&gt;</span> ?&#8288;env:string array <span>&#45;&gt;</span> ?&#8288;name:string <span>&#45;&gt;</span> ?&#8288;text:string <span>&#45;&gt;</span> ?&#8288;metadata:(string<span class="keyword"> * </span>string) list <span>&#45;&gt;</span> ?&#8288;allow_stdin:bool <span>&#45;&gt;</span> ?&#8288;dir:string <span>&#45;&gt;</span> ?&#8288;check_existence:bool <span>&#45;&gt;</span> string <span>&#45;&gt;</span> string list <span>&#45;&gt;</span> OpamProcess.command</code></dt><dd><p>Make a comman suitable for OpamProcess.Job. if <code>verbose</code>, is set, command and output will be displayed (at command end for the latter, if concurrent commands are running). <code>name</code> is used for naming log files. <code>text</code> is what is displayed in the status line for this command. May raise Command_not_found, unless <code>check_existence</code> is set to false (in which case you can end up with a process error instead)</p></dd></dl><aside><p>OLD COMMAND API, DEPRECATED</p></aside><dl><dt class="spec type" id="type-command"><a href="#type-command" class="anchor"></a><code><span class="keyword">type </span>command</code><code><span class="keyword"> = </span>string list</code></dt><dd><p>a command is a list of words</p></dd></dl><dl><dt class="spec value" id="val-command_exists"><a href="#val-command_exists" class="anchor"></a><code><span class="keyword">val </span>command_exists : ?&#8288;env:string array <span>&#45;&gt;</span> ?&#8288;dir:string <span>&#45;&gt;</span> string <span>&#45;&gt;</span> bool</code></dt><dd><p>Test whether a command exists in the environment.</p></dd></dl><dl><dt class="spec value" id="val-command"><a href="#val-command" class="anchor"></a><code><span class="keyword">val </span>command : ?&#8288;verbose:bool <span>&#45;&gt;</span> ?&#8288;env:string array <span>&#45;&gt;</span> ?&#8288;name:string <span>&#45;&gt;</span> ?&#8288;metadata:(string<span class="keyword"> * </span>string) list <span>&#45;&gt;</span> ?&#8288;allow_stdin:bool <span>&#45;&gt;</span> <a href="index.html#type-command">command</a> <span>&#45;&gt;</span> unit</code></dt><dd><p><code>command cmd</code> executes the command <code>cmd</code> in the correct OPAM environment.</p></dd></dl><dl><dt class="spec value" id="val-commands"><a href="#val-commands" class="anchor"></a><code><span class="keyword">val </span>commands : ?&#8288;verbose:bool <span>&#45;&gt;</span> ?&#8288;env:string array <span>&#45;&gt;</span> ?&#8288;name:string <span>&#45;&gt;</span> ?&#8288;metadata:(string<span class="keyword"> * </span>string) list <span>&#45;&gt;</span> ?&#8288;keep_going:bool <span>&#45;&gt;</span> <a href="index.html#type-command">command</a> list <span>&#45;&gt;</span> unit</code></dt><dd><p><code>commands cmds</code> executes the commands <code>cmds</code> in the correct OPAM environment. It stops whenever one command fails unless <code>keep_going</code> is set to <code>true</code>. In this case, the first error is re-raised at the end.</p></dd></dl><dl><dt class="spec value" id="val-read_command_output"><a href="#val-read_command_output" class="anchor"></a><code><span class="keyword">val </span>read_command_output : ?&#8288;verbose:bool <span>&#45;&gt;</span> ?&#8288;env:string array <span>&#45;&gt;</span> ?&#8288;metadata:(string<span class="keyword"> * </span>string) list <span>&#45;&gt;</span> ?&#8288;allow_stdin:bool <span>&#45;&gt;</span> <a href="index.html#type-command">command</a> <span>&#45;&gt;</span> string list</code></dt><dd><p><code>read_command_output cmd</code> executes the command <code>cmd</code> in the correct OPAM environment and return the lines from stdout if the command exists normally. If the command does not exist or if the command exited with a non-empty exit-code, throw an error.</p></dd></dl><aside><p>END</p></aside><dl><dt class="spec value" id="val-is_tar_archive"><a href="#val-is_tar_archive" class="anchor"></a><code><span class="keyword">val </span>is_tar_archive : string <span>&#45;&gt;</span> bool</code></dt><dd><p>Test whether the file is an archive, by looking as its extension</p></dd></dl><dl><dt class="spec value" id="val-extract"><a href="#val-extract" class="anchor"></a><code><span class="keyword">val </span>extract : string <span>&#45;&gt;</span> string <span>&#45;&gt;</span> unit</code></dt><dd><p><code>extract filename dirname</code> extracts the archive <code>filename</code> into <code>dirname</code>. <code>dirname</code> should not exists and <code>filename</code> should contain only one top-level directory.</p></dd></dl><dl><dt class="spec value" id="val-extract_in"><a href="#val-extract_in" class="anchor"></a><code><span class="keyword">val </span>extract_in : string <span>&#45;&gt;</span> string <span>&#45;&gt;</span> unit</code></dt><dd><p><code>extract_in filename dirname</code> extracts the archive <code>filename</code> into <code>dirname</code>. <code>dirname</code> should already exists.</p></dd></dl><dl><dt class="spec value" id="val-mkdir"><a href="#val-mkdir" class="anchor"></a><code><span class="keyword">val </span>mkdir : string <span>&#45;&gt;</span> unit</code></dt><dd><p>Create a directory. Do not fail if the directory already exist.</p></dd></dl><dl><dt class="spec value" id="val-cpu_count"><a href="#val-cpu_count" class="anchor"></a><code><span class="keyword">val </span>cpu_count : unit <span>&#45;&gt;</span> int</code></dt><dd><p>Get the number of active processors on the system</p></dd></dl><section><header><h3 id="file-locking-function"><a href="#file-locking-function" class="anchor"></a>File locking function</h3></header><dl><dt class="spec type" id="type-lock"><a href="#type-lock" class="anchor"></a><code><span class="keyword">type </span>lock</code></dt></dl><dl><dt class="spec value" id="val-flock"><a href="#val-flock" class="anchor"></a><code><span class="keyword">val </span>flock : ?&#8288;read:bool <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <a href="index.html#type-lock">lock</a></code></dt><dd><p>Acquires a lock on the given file. Retries 5 times max. By default, this is a write lock.</p></dd></dl><dl><dt class="spec value" id="val-funlock"><a href="#val-funlock" class="anchor"></a><code><span class="keyword">val </span>funlock : <a href="index.html#type-lock">lock</a> <span>&#45;&gt;</span> unit</code></dt><dd><p>Releases an acquired lock</p></dd></dl></section><section><header><h3 id="misc"><a href="#misc" class="anchor"></a>Misc</h3></header><dl><dt class="spec value" id="val-patch"><a href="#val-patch" class="anchor"></a><code><span class="keyword">val </span>patch : string <span>&#45;&gt;</span> unit</code></dt><dd><p>Apply a patch file in the current directory.</p></dd></dl><dl><dt class="spec value" id="val-temp_file"><a href="#val-temp_file" class="anchor"></a><code><span class="keyword">val </span>temp_file : ?&#8288;dir:string <span>&#45;&gt;</span> string <span>&#45;&gt;</span> string</code></dt><dd><p>Create a tempory file in <i>~/.opam/logs/&lt;name&gt;XXX</i></p></dd></dl><dl><dt class="spec value" id="val-print_stats"><a href="#val-print_stats" class="anchor"></a><code><span class="keyword">val </span>print_stats : unit <span>&#45;&gt;</span> unit</code></dt><dd><p>Print stats</p></dd></dl><dl><dt class="spec value" id="val-register_printer"><a href="#val-register_printer" class="anchor"></a><code><span class="keyword">val </span>register_printer : unit <span>&#45;&gt;</span> unit</code></dt><dd><p>Registers an exception printer that adds some OPAM version info, and details on process and Unix errors</p></dd></dl><dl><dt class="spec value" id="val-init"><a href="#val-init" class="anchor"></a><code><span class="keyword">val </span>init : unit <span>&#45;&gt;</span> unit</code></dt><dd><p>Initialises signal handlers, catch_break and some exception printers. The lib may not perform properly without this if <code>Sys.catch_break</code> isn't set and SIGPIPE isn't handled (with a no-op)</p></dd></dl></section></div></body></html>