<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>OpamSwitchState (opam-state.OpamSwitchState)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">opam-state</a> &#x00BB; OpamSwitchState</nav><h1>Module <code>OpamSwitchState</code></h1><p>Loading and querying a switch state</p><nav class="toc"><ul><li><a href="#helpers-to-access-state-data">Helpers to access state data</a></li><li><a href="#updating">Updating</a></li><li><a href="#user-interaction-and-reporting">User interaction and reporting</a></li></ul></nav></header><dl><dt class="spec value" id="val-load"><a href="#val-load" class="anchor"></a><code><span class="keyword">val </span>load : <span class="type-var">'a</span> OpamStateTypes.lock <span>&#45;&gt;</span> <span class="type-var">'b</span> OpamStateTypes.global_state <span>&#45;&gt;</span> <span class="type-var">'c</span> OpamStateTypes.repos_state <span>&#45;&gt;</span> OpamTypes.switch <span>&#45;&gt;</span> <span class="type-var">'a</span> OpamStateTypes.switch_state</code></dt><dt class="spec value" id="val-with_"><a href="#val-with_" class="anchor"></a><code><span class="keyword">val </span>with_ : <span class="type-var">'a</span> OpamStateTypes.lock <span>&#45;&gt;</span> ?&#8288;rt:[&lt; OpamStateTypes.unlocked ] OpamStateTypes.repos_state <span>&#45;&gt;</span> ?&#8288;switch:OpamTypes.switch <span>&#45;&gt;</span> [&lt; OpamStateTypes.unlocked ] OpamStateTypes.global_state <span>&#45;&gt;</span> (<span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> <span class="type-var">'b</span>) <span>&#45;&gt;</span> <span class="type-var">'b</span></code></dt><dd><p>Loads the switch state and calls the given function on it, releasing the lock afterwards.</p><p>The repository state is automatically loaded if not provided.</p><p>The switch is selected, if not set, using <code>OpamStateConfig.get_switch</code> -- which can fail if no switch is configured.</p><p>Additionally, in case of a write lock, a backup is saved and a message is printed on restoring if <code>f</code> raised an exception and there were changes.</p></dd></dl><dl><dt class="spec value" id="val-load_virtual"><a href="#val-load_virtual" class="anchor"></a><code><span class="keyword">val </span>load_virtual : ?&#8288;repos_list:OpamTypes.repository_name list <span>&#45;&gt;</span> <span class="type-var">'a</span> OpamStateTypes.global_state <span>&#45;&gt;</span> <span class="type-var">'b</span> OpamStateTypes.repos_state <span>&#45;&gt;</span> OpamStateTypes.unlocked OpamStateTypes.switch_state</code></dt><dd><p>Creates a virtual state with all package available and nothing installed. Useful for querying and simulating actions when no switch is yet configured, or querying packages directly from the repos</p></dd></dl><dl><dt class="spec value" id="val-load_selections"><a href="#val-load_selections" class="anchor"></a><code><span class="keyword">val </span>load_selections : <span class="type-var">'a</span> OpamStateTypes.global_state <span>&#45;&gt;</span> OpamTypes.switch <span>&#45;&gt;</span> OpamTypes.switch_selections</code></dt><dd><p>Load the switch's state file, without constructing the package maps: much faster than loading the full switch state</p></dd></dl><dl><dt class="spec value" id="val-compute_available_packages"><a href="#val-compute_available_packages" class="anchor"></a><code><span class="keyword">val </span>compute_available_packages : <span class="type-var">'a</span> OpamStateTypes.global_state <span>&#45;&gt;</span> OpamTypes.switch <span>&#45;&gt;</span> OpamFile.Switch_config.t <span>&#45;&gt;</span> pinned:OpamTypes.package_set <span>&#45;&gt;</span> opams:OpamFile.OPAM.t OpamTypes.package_map <span>&#45;&gt;</span> OpamTypes.package_set</code></dt><dd><p>Raw function to compute the availability of all packages, in <code>opams</code>, given the switch configuration and the set of pinned packages. (The result is precomputed in global_state.available_packages once the state is loaded)</p></dd></dl><dl><dt class="spec value" id="val-unlock"><a href="#val-unlock" class="anchor"></a><code><span class="keyword">val </span>unlock : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamStateTypes.unlocked OpamStateTypes.switch_state</code></dt><dd><p>Releases any locks on the given switch_state</p></dd></dl><dl><dt class="spec value" id="val-with_write_lock"><a href="#val-with_write_lock" class="anchor"></a><code><span class="keyword">val </span>with_write_lock : ?&#8288;dontblock:bool <span>&#45;&gt;</span> <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> (OpamStateTypes.rw OpamStateTypes.switch_state <span>&#45;&gt;</span> <span class="type-var">'b</span><span class="keyword"> * </span>OpamStateTypes.rw OpamStateTypes.switch_state) <span>&#45;&gt;</span> <span class="type-var">'b</span><span class="keyword"> * </span><span class="type-var">'a</span> OpamStateTypes.switch_state</code></dt><dd><p>Calls the provided function, ensuring a temporary write lock on the given switch state</p></dd></dl><section><header><h3 id="helpers-to-access-state-data"><a href="#helpers-to-access-state-data" class="anchor"></a>Helpers to access state data</h3></header><dl><dt class="spec value" id="val-repos_list"><a href="#val-repos_list" class="anchor"></a><code><span class="keyword">val </span>repos_list : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamTypes.repository_name list</code></dt><dd><p>Returns the repositories configured in the current switch or, if none, the globally set default. highest priority first.</p></dd></dl><dl><dt class="spec value" id="val-selections"><a href="#val-selections" class="anchor"></a><code><span class="keyword">val </span>selections : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamTypes.switch_selections</code></dt><dt class="spec value" id="val-opam"><a href="#val-opam" class="anchor"></a><code><span class="keyword">val </span>opam : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamTypes.package <span>&#45;&gt;</span> OpamFile.OPAM.t</code></dt><dd><p>Return the OPAM file for the given package.</p><dl><dt>raises Not_found</dt><dd><p>when appropriate</p></dd></dl></dd></dl><dl><dt class="spec value" id="val-opam_opt"><a href="#val-opam_opt" class="anchor"></a><code><span class="keyword">val </span>opam_opt : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamTypes.package <span>&#45;&gt;</span> OpamFile.OPAM.t option</code></dt><dd><p>Return the OPAM file, including URL and descr, for the given package, if any</p></dd></dl><dl><dt class="spec value" id="val-url"><a href="#val-url" class="anchor"></a><code><span class="keyword">val </span>url : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamTypes.package <span>&#45;&gt;</span> OpamFile.URL.t option</code></dt><dd><p>Return the URL file for the given package</p></dd></dl><dl><dt class="spec value" id="val-primary_url"><a href="#val-primary_url" class="anchor"></a><code><span class="keyword">val </span>primary_url : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamTypes.package <span>&#45;&gt;</span> OpamTypes.url option</code></dt><dd><p>Returns the primary URL from the URL file of the given package</p></dd></dl><dl><dt class="spec value" id="val-descr"><a href="#val-descr" class="anchor"></a><code><span class="keyword">val </span>descr : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamTypes.package <span>&#45;&gt;</span> OpamFile.Descr.t</code></dt><dd><p>Return the Descr file for the given package (or an empty descr if none)</p></dd></dl><dl><dt class="spec value" id="val-descr_opt"><a href="#val-descr_opt" class="anchor"></a><code><span class="keyword">val </span>descr_opt : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamTypes.package <span>&#45;&gt;</span> OpamFile.Descr.t option</code></dt><dd><p>Return the Descr file for the given package</p></dd></dl><dl><dt class="spec value" id="val-files"><a href="#val-files" class="anchor"></a><code><span class="keyword">val </span>files : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamTypes.package <span>&#45;&gt;</span> OpamTypes.filename list</code></dt><dd><p>Returns the full paths of overlay files under the files/ directory</p></dd></dl><dl><dt class="spec value" id="val-package_config"><a href="#val-package_config" class="anchor"></a><code><span class="keyword">val </span>package_config : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamTypes.name <span>&#45;&gt;</span> OpamFile.Dot_config.t</code></dt><dd><p>Return the installed package's local configuration</p></dd></dl><dl><dt class="spec value" id="val-is_name_installed"><a href="#val-is_name_installed" class="anchor"></a><code><span class="keyword">val </span>is_name_installed : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamTypes.name <span>&#45;&gt;</span> bool</code></dt><dd><p>Check whether a package name is installed</p></dd></dl><dl><dt class="spec value" id="val-find_installed_package_by_name"><a href="#val-find_installed_package_by_name" class="anchor"></a><code><span class="keyword">val </span>find_installed_package_by_name : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamTypes.name <span>&#45;&gt;</span> OpamTypes.package</code></dt><dd><p>Return the installed package with the right name</p><dl><dt>raises Not_found</dt><dd><p>when appropriate</p></dd></dl></dd></dl><dl><dt class="spec value" id="val-packages_of_atoms"><a href="#val-packages_of_atoms" class="anchor"></a><code><span class="keyword">val </span>packages_of_atoms : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamTypes.atom list <span>&#45;&gt;</span> OpamTypes.package_set</code></dt><dd><p>Return all packages satisfying one of the given atoms from a state</p></dd></dl><dl><dt class="spec value" id="val-get_package"><a href="#val-get_package" class="anchor"></a><code><span class="keyword">val </span>get_package : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamTypes.name <span>&#45;&gt;</span> OpamTypes.package</code></dt><dd><p>Gets the current version of package <code>name</code>: pinned version, installed version, max available version or max existing version, tried in this order.</p><dl><dt>raises Not_found</dt><dd><p>only if there is no package by this name</p></dd></dl></dd></dl><dl><dt class="spec value" id="val-is_dev_package"><a href="#val-is_dev_package" class="anchor"></a><code><span class="keyword">val </span>is_dev_package : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamTypes.package <span>&#45;&gt;</span> bool</code></dt><dd><p>&quot;dev packages&quot; are any package with an upstream that isn't the usual HTTP, and without an archive checksum. These need to be updated from upstream independently when installed. It's generally only the case of source-pinned packages, but no rule enforces it in opam itself.</p></dd></dl><dl><dt class="spec value" id="val-is_pinned"><a href="#val-is_pinned" class="anchor"></a><code><span class="keyword">val </span>is_pinned : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamTypes.name <span>&#45;&gt;</span> bool</code></dt><dd><p>Checks if the given package name is pinned</p></dd></dl><dl><dt class="spec value" id="val-is_version_pinned"><a href="#val-is_version_pinned" class="anchor"></a><code><span class="keyword">val </span>is_version_pinned : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamTypes.name <span>&#45;&gt;</span> bool</code></dt><dd><p>Checks if the given package is version-pinned, i.e. pinned without overlay metadata, and relying on the repo's data</p></dd></dl><dl><dt class="spec value" id="val-dev_packages"><a href="#val-dev_packages" class="anchor"></a><code><span class="keyword">val </span>dev_packages : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamTypes.package_set</code></dt><dd><p>The set of all &quot;dev packages&quot; (see <code>is_dev_package</code> for a definition)</p></dd></dl><dl><dt class="spec value" id="val-source_dir"><a href="#val-source_dir" class="anchor"></a><code><span class="keyword">val </span>source_dir : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamTypes.package <span>&#45;&gt;</span> OpamTypes.dirname</code></dt><dd><p>Returns the local source mirror for the given package (<code>OpamPath.Switch.sources</code> or <code>OpamPath.Switch.pinned_package</code>, depending on wether it's pinned).</p></dd></dl><dl><dt class="spec value" id="val-depexts"><a href="#val-depexts" class="anchor"></a><code><span class="keyword">val </span>depexts : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamTypes.package <span>&#45;&gt;</span> OpamStd.String.Set.t</code></dt><dd><p>Returns the set of active external dependencies for the package, computed from the values of the system-specific variables</p></dd></dl><dl><dt class="spec value" id="val-conflicts_with"><a href="#val-conflicts_with" class="anchor"></a><code><span class="keyword">val </span>conflicts_with : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamTypes.package_set <span>&#45;&gt;</span> OpamTypes.package_set <span>&#45;&gt;</span> OpamTypes.package_set</code></dt><dd><p><code>conflicts_with st subset pkgs</code> returns all packages declared in conflict with at least one element of <code>subset</code> within <code>pkgs</code>, through forward or backward conflict definition or common conflict-class. Packages in <code>subset</code> (all their versions) are excluded from the result.</p></dd></dl><dl><dt class="spec value" id="val-universe"><a href="#val-universe" class="anchor"></a><code><span class="keyword">val </span>universe : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> ?&#8288;test:bool <span>&#45;&gt;</span> ?&#8288;doc:bool <span>&#45;&gt;</span> ?&#8288;force_dev_deps:bool <span>&#45;&gt;</span> ?&#8288;reinstall:OpamTypes.package_set <span>&#45;&gt;</span> requested:OpamTypes.name_set <span>&#45;&gt;</span> OpamTypes.user_action <span>&#45;&gt;</span> OpamTypes.universe</code></dt><dd><p>Put the package data in a form suitable for the solver, pre-computing some maps and sets. Packages in the <code>requested</code> set are the ones that will get affected by the global <code>build_test</code> and <code>build_doc</code> flags. <code>test</code> and <code>doc</code>, if unspecified, are taken from <code>OpamStateConfig.r</code>. <code>reinstall</code> marks package not considered current in the universe, and that should therefore be reinstalled. If unspecified, it is the packages marked in <code>switch_state.reinstall</code> that are present in <code>requested</code>.</p></dd></dl><dl><dt class="spec value" id="val-dump_pef_state"><a href="#val-dump_pef_state" class="anchor"></a><code><span class="keyword">val </span>dump_pef_state : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> Pervasives.out_channel <span>&#45;&gt;</span> unit</code></dt><dd><p>Dumps the current switch state in PEF format, for interaction with Dose tools</p></dd></dl></section><section><header><h3 id="updating"><a href="#updating" class="anchor"></a>Updating</h3></header><dl><dt class="spec value" id="val-update_package_metadata"><a href="#val-update_package_metadata" class="anchor"></a><code><span class="keyword">val </span>update_package_metadata : OpamTypes.package <span>&#45;&gt;</span> OpamFile.OPAM.t <span>&#45;&gt;</span> <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> <span class="type-var">'a</span> OpamStateTypes.switch_state</code></dt><dd><p>Sets the given opam file for the given package, updating the other related fields along the way</p></dd></dl><dl><dt class="spec value" id="val-remove_package_metadata"><a href="#val-remove_package_metadata" class="anchor"></a><code><span class="keyword">val </span>remove_package_metadata : OpamTypes.package <span>&#45;&gt;</span> <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> <span class="type-var">'a</span> OpamStateTypes.switch_state</code></dt><dd><p>Removes the metadata associated to the given package, also updating the packages and available sets.</p></dd></dl><dl><dt class="spec value" id="val-update_pin"><a href="#val-update_pin" class="anchor"></a><code><span class="keyword">val </span>update_pin : OpamTypes.package <span>&#45;&gt;</span> OpamFile.OPAM.t <span>&#45;&gt;</span> <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> <span class="type-var">'a</span> OpamStateTypes.switch_state</code></dt><dd><p>Like <code>update_package_metadata</code>, but also ensures the package is pinned to the given version. The version specified in the opam file, if any, takes precedence over the version of <code>package</code>. Also marks it for reinstall if changed.</p></dd></dl><dl><dt class="spec value" id="val-update_repositories"><a href="#val-update_repositories" class="anchor"></a><code><span class="keyword">val </span>update_repositories : <span class="type-var">'a</span> OpamStateTypes.global_state <span>&#45;&gt;</span> (OpamTypes.repository_name list <span>&#45;&gt;</span> OpamTypes.repository_name list) <span>&#45;&gt;</span> OpamTypes.switch <span>&#45;&gt;</span> unit</code></dt><dd><p>Updates the selected repositories in the given switch (does not load the full switch state, but takes a transient write lock on the switch, so make sure not to hold other locks to avoid deadlocks). Sets the switch repositories in any case, even if unchanged from the defaults.</p></dd></dl></section><section><header><h3 id="user-interaction-and-reporting"><a href="#user-interaction-and-reporting" class="anchor"></a>User interaction and reporting</h3></header><dl><dt class="spec value" id="val-is_switch_globally_set"><a href="#val-is_switch_globally_set" class="anchor"></a><code><span class="keyword">val </span>is_switch_globally_set : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> bool</code></dt><dd><p>Returns <code>true</code> if the switch of the state is the one set in <code>$OPAMROOT/config</code>, <code>false</code> otherwise. This doesn't imply that the switch is current w.r.t. either the process or the shell, for that you need to check <code>OpamStateConfig.(!r.switch_from)</code></p></dd></dl><dl><dt class="spec value" id="val-not_found_message"><a href="#val-not_found_message" class="anchor"></a><code><span class="keyword">val </span>not_found_message : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> OpamTypes.atom <span>&#45;&gt;</span> string</code></dt><dd><p>Returns a message about a package or version that couldn't be found</p></dd></dl><dl><dt class="spec value" id="val-unavailable_reason"><a href="#val-unavailable_reason" class="anchor"></a><code><span class="keyword">val </span>unavailable_reason : <span class="type-var">'a</span> OpamStateTypes.switch_state <span>&#45;&gt;</span> ?&#8288;default:string <span>&#45;&gt;</span> (OpamTypes.name<span class="keyword"> * </span>OpamFormula.version_formula) <span>&#45;&gt;</span> string</code></dt><dd><p>Returns a printable explanation why a package is not currently available (pinned to an incompatible version, unmet <code>available:</code> constraints...). <code>default</code> is returned if no reason why it wouldn't be available was found (empty string if unspecified).</p></dd></dl></section></div></body></html>